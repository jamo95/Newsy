{% extends "base.html" %}
{% block content %}
<div id="summarised" class="container">
  <h1>Newsy Summarizer</h1>

  <form action="" method="post" name="summarizer">
    {{ form.hidden_tag() }}

    <p id="text-input">
      Enter title:<br />
      {{ form.title(id='summarizer-title-input', size=80) }}<br />
      Enter text:<br />
      {{ form.text(id='summarizer-text-input', cols=90, rows=5) }}<br />
    </p>

    <p id="url-input">
      Enter link:<br />
      {{ form.url(id='summarizer-url-input', size=80) }}<br />
    </p>

    <p id="n-sentences-input">
      Enter number of sentences:<br />
      {{ form.count(id='summarizer-n-sentences-input') }}<br />
    </p>

    {% if form_error %}
      <span style="color: red;">{{ form_error }}</span>
    {% endif %}

    <p id="btn-submit"><input type="submit" value="Summarize"></p>
    <p><a id="switch-input-link"
      onClick="switchSummarizerInput()">Enter text instead</a></p>
  </form>

  <hr />

  <div id= "summarised-article">
    <div id="summarised-article-title">
      {% if article_title %}
        {% if article_url %}
          <h2><a href={{ article_url }}>{{ article_title }}</a></h2>
        {% else %}
          <h2>{{ article_title }}</h2>
        {% endif %}
      {% endif %}
    </div>

    {% if article_sentences %}
      <div id="summarised-article-content">
        {% for sentence in article_sentences %}
          <p>{{ sentence }}</p>
        {% endfor %}
      </div>
    {% endif %}

    {% if article_analysis %}
      <div id="summarised-article-content">
        <p class="analysis">Article's Sentiment Analyisis: {{ article_analysis }}</p>
      </div>
    {% endif %}

    {% if article_url %}
      {% if article_keywords %}
        <div id="summarised-article-content">
          <h4>Keywords</h4>
          <p>
          {% for keyword in article_keywords%}
              <span>{{ keyword }}</a>,
          {% endfor %}
          </p>
          <input type="button" onclick="highlightAll('{{" ".join(article_keywords) }}')" value="Highlight keywords">
          <br />
          <br />
          <i>Suggest keywords (space separated):</i>
          <form action = "{{ url_for('summarised', url=article_url) }}" method="POST">
            <input type="text" name="keywords">
          </form>
        </div>
      {% endif %}
    {% else %}
      {% if article_keywords %}
        <div id="summarised-article-content">
          <h4>Keywords</h4>
          <p>
          {% for keyword in article_keywords %}
              <span>{{ keyword }}</a>,
          {% endfor %}
          </p>
          <input type="button" onclick="highlightAll('{{" ".join(article_keywords) }}')" value="Highlight keywords">
          <br />
          <br />
        </div>

      {% endif %}
    {% endif %}
    {% if article_sentences %}
      <div id="summarised-review">
        <h3 id="summarised-review-question">Was this a good summary?
          <a onClick="summarisedReview(true)">Yes</a> or
          <a onClick="summarisedReview(false)">No</a>
        </h3>
        <p id="summarised-positive-response" style="display: none;">Thanks for the
        positive review!</p><p id="summarised-negative-response" style="display:
        none;">Sorry to hear that. We have been notified and promise to make
        Newsy better for you.</p>
        {% if good_review or bad_review %}
          <br />
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
          <!-- image from https://cdnjs.com/libraries/font-awesome -->
          <i id="positive-unvoted" class="fa fa-thumbs-o-up" style="font-size:36px;color:green"><a id="postive-unvoted" style="padding-right:25px;padding-left:25px">{{ good_review }} </a></i>
          <i id="positive-voted" class="fa fa-thumbs-o-up" style="font-size:36px;color:green;display: none;"><a style="padding-right:25px;padding-left:25px">{{ good_review + 1 }}</a></i>
          <i id="negative-unvoted" class="fa fa-thumbs-o-down" style="font-size:36px;color:red"><a style="padding-right:25px;padding-left:25px">{{ bad_review }}</a></i>
          <i id="negative-voted" class="fa fa-thumbs-o-down" style="font-size:36px;color:red;display: none;"><a style="padding-right:25px;padding-left:25px">{{ bad_review + 1}}</a></i>
        {% endif %}
      </div>

    {% endif %}
  </div>
</div>

<script type="text/javascript">
  let inputType = window.location.hash === '#text' ? 'text' : 'url';
  window.onload = function() {
    let url = getUrlParameter('url');

    if (url) {
      window.history.replaceState(
        {}, '{{ title }}', '{{ url_for("summarised") }}');
      $('#summarizer-url-input')[0].value = url;
    }

    setSummarizerInput(inputType);
  }();

  let summarisedReview = function(isPositive) {
    $('#summarised-review-question').hide();

    if (isPositive) {
      $('#summarised-negative-response').hide();
      $('#summarised-positive-response').show();
      $('#positive-unvoted').hide();
      $('#positive-voted').show();
    } else {
      $('#summarised-negative-response').show();
      $('#summarised-positive-response').hide();
      $('#negative-unvoted').hide();
      $('#negative-voted').show();
    }

    $.ajax({
      type: "POST", dataType: 'json',
      url: '/review',
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify({
        review: isPositive ? 'positive' : 'negative',
        title: $('#summarizer-title-input')[0].value,
        text: $('#summarizer-text-input')[0].value,
        url: $('#summarizer-url-input')[0].value,
        sentences: $('#summarizer-n-sentences-input')[0].value,
      }),
    });
  }

  function highlightAll(keywords)
  {
      var summary_text = document.getElementById("summarised-article-content");
      var arr = Array.from(keywords.split(" "));
      for (idx in arr) {
        summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp(arr[idx], "ig" ),"<span class=\"highlight\">"+ '\$&'+"</span>");
      }
  }

</script>

<style>
.highlight
{
background-color:yellow;
}

.clickableSpan {
    cursor: pointer;
}
</style>

{% endblock %}
