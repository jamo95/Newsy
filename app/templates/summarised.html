{% extends "base.html" %}
{% block content %}
<div id="summarised" class="container">
  <h1>Newsy Summarizer</h1>

  <form action="" method="post" name="summarizer">
    {{ form.hidden_tag() }}

    <p id="text-input">
      Enter title:<br />
      {{ form.title(id='summarizer-title-input', size=70) }}<br />
      Enter text:<br />
      {{ form.text(id='summarizer-text-input', cols=70, rows=5) }}<br />
    </p>

    <p id="url-input">
      Enter link:<br />
      {{ form.url(id='summarizer-url-input', size=70) }}<br />
    </p>

    <p id="n-sentences-input">
      Enter number of sentences:<br />
      {{ form.count(id='summarizer-n-sentences-input') }}<br />
    </p>

    {% if form_error %}
      <span style="color: red;">{{ form_error }}</span>
    {% endif %}

    <p id="btn-submit"><input type="submit" value="Summarize"></p>
    <p><a id="switch-input-link"
      onClick="switchSummarizerInput()">Enter text instead</a></p>
  </form>

  <hr />

  <div id= "summarised-article">
    <div id="summarised-article-title">
      {% if article_title %}
        {% if article_url %}
          <h2><a href={{ article_url }} >{{ article_title }}</a></h2>
        {% else %}
          <h2>{{ article_title }}</h2>
        {% endif %}
      {% endif %}
    </div>

    {% if article_sentences %}
        <div id="summarised-article-content">
          {% for sentence in article_sentences %}
            <p>{{ sentence }}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% if article_analysis %}
      <br />
        <div id="summarised-article-analysis">
          <div class="bar-container-legend" style="text-align: center; font-weight: bold;"><>Sentiment Analysis Distribution</div>
          <div class="bar-chart">
              <div class="bar-container">
                  <div class="bar positive" style="width: {{ '{:.1%}'.format(positive_sentiment) }}"></div>
                  <div class="bar neutral" style="width: {{ '{:.1%}'.format(neutral_sentiment) }}"></div>
                  <div class="bar negative" style="width: {{ '{:.1%}'.format(negative_sentiment) }}"></div>
              </div>
          </div>
          <br />
          <div>
          <div class="bar-chart-legend">
            <div class="bar-container-legend">
                <div class="key-section">
                  <span style="color:#93FF33;margin-right: 5px">&#x2588;</span>
                  <span style="margin-right: 10px">Positive</span>
                  <span style="margin-right: 10px">{{ '{:.1%}'.format(positive_sentiment) }}</span>
                </div>
                <div class="key-section">
                  <span style="color:#FFF933;margin-right: 10px">&#x2588;</span>
                  <span style="margin-right: 10px">Neutral</span>
                  <span >{{ '{:.1%}'.format(neutral_sentiment) }}</span>
                </div>
                <div class="key-section">
                  <span style="color:#FF5833;margin-right: 10px">&#x2588;</span>
                  <span style="margin-right: 10px">Negative</span>
                  <span >{{ '{:.1%}'.format(negative_sentiment) }}</span>
                </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}


    {% if article_url %}
      {% if article_keywords %}
        <div id="summarised-article-content">
          <h4>Keywords</h4>
          <p>
          {% for keyword in article_keywords%}
              <span>{{ keyword }}</a>,
          {% endfor %}
          </p>
          <input id="article-highlight" type="button" onclick="articleHighlightAll('{{" ".join(article_keywords) }}')" value="Highlight keywords">
          <input id="article-unhighlight" style="display: none" type="button" onclick="articleUnhighlightAll()" value="Unhighlight keywords">
          <br />
          <br />
          <i>Suggest keywords (space separated):</i>
          <form action = "{{ url_for('summarised', url=article_url) }}" method="POST">
            <input type="text" name="keywords">
          </form>
        </div>
      {% endif %}
    {% else %}
      {% if article_keywords %}
        <div id="summarised-article-content">
          <h4>Keywords</h4>
          <p>
          {% for keyword in article_keywords %}
              <span>{{ keyword }}</a>,
          {% endfor %}
          </p>
          <input id="text-highlight" type="button" onclick="textHighlightAll('{{" ".join(article_keywords) }}')" value="Highlight keywords">
          <input id="text-unhighlight" style="display: none" type="button" onclick="textUnhighlightAll()" value="Unhighlight keywords">
          <br />
          <br />
        </div>

      {% endif %}
    {% endif %}

    {% if article_sentences %}
      <br />
      <div id="summarised-review">
        <h4 id="summarised-review-question">Was this a good summary?
          <a onClick="summarisedReview(true)">Yes</a> or
          <a onClick="summarisedReview(false)">No</a>
        </h4>
        <p id="summarised-positive-response" style="display: none;">Thanks for the
        positive review!</p><p id="summarised-negative-response" style="display:
        none;">Sorry to hear that. We have been notified and promise to make
        Newsy better for you.</p>
        {% if good_review or bad_review %}
          <br />
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
          <!-- image from https://cdnjs.com/libraries/font-awesome -->
          <i id="positive-unvoted" class="fa fa-thumbs-o-up" style="font-size:36px;color:green"><a id="postive-unvoted" style="padding-right:25px;padding-left:25px">{{ good_review }} </a></i>
          <i id="positive-voted" class="fa fa-thumbs-o-up" style="font-size:36px;color:green;display: none;"><a style="padding-right:25px;padding-left:25px">{{ good_review + 1 }}</a></i>
          <i id="negative-unvoted" class="fa fa-thumbs-o-down" style="font-size:36px;color:red"><a style="padding-right:25px;padding-left:25px">{{ bad_review }}</a></i>
          <i id="negative-voted" class="fa fa-thumbs-o-down" style="font-size:36px;color:red;display: none;"><a style="padding-right:25px;padding-left:25px">{{ bad_review + 1}}</a></i>
        {% endif %}
      </div>

    {% endif %}
    {% if similar_articles %}
      <br />
      <br />
      <div id="summarised-similar-articles">
        <h3>Similar article recommendations</h3>
        <br />
        {% for article_date in similar_articles.keys() | sort(reverse=True) %}
          <h4>{{ article_date }}</h4>
          <ul>
              {% for article in similar_articles.get(article_date) %}
                <li>
                  <h3><a href="{{ url_for('summarised') + '?url=' + article.url }}">
                      {{ article.title }}
                  </a></h3>

                  {% for sentence in article.sentences[:2] | sort(attribute='index') %}
                    <p>{{ sentence['data'] }}</p>
                  {% endfor %}
                </li>
              {% endfor %}
          </ul>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script type="text/javascript">
  let inputType = window.location.hash === '#text' ? 'text' : 'url';
  window.onload = function() {
    let url = getUrlParameter('url');

    if (url) {
      window.history.replaceState(
        {}, '{{ title }}', '{{ url_for("summarised") }}');
      $('#summarizer-url-input')[0].value = url;
    }

    setSummarizerInput(inputType);
  }();

  let summarisedReview = function(isPositive) {
    $('#summarised-review-question').hide();

    if (isPositive) {
      $('#summarised-negative-response').hide();
      $('#summarised-positive-response').show();
      $('#positive-unvoted').hide();
      $('#positive-voted').show();
    } else {
      $('#summarised-negative-response').show();
      $('#summarised-positive-response').hide();
      $('#negative-unvoted').hide();
      $('#negative-voted').show();
    }

    $.ajax({
      type: "POST", dataType: 'json',
      url: '/review',
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify({
        review: isPositive ? 'positive' : 'negative',
        title: $('#summarizer-title-input')[0].value,
        text: $('#summarizer-text-input')[0].value,
        url: $('#summarizer-url-input')[0].value,
        sentences: $('#summarizer-n-sentences-input')[0].value,
      }),
    });
  }

  function articleHighlightAll(keywords)
  {
      var summary_text = document.getElementById("summarised-article-content");
      var arr = Array.from(keywords.split(" "));
      for (idx in arr) {
        summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp(arr[idx], "ig" ),"<span class=\"highlight\">"+ '\$&'+"</span>");
      }
      $('#article-highlight').hide();
      $('#article-unhighlight').show();
  }

  function articleUnhighlightAll()
  {
      var summary_text = document.getElementById("summarised-article-content");
      summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp("<span class=\"highlight\">", "ig" ),"");
      summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp("</span>", "ig" ),"");
      $('#article-unhighlight').hide();
      $('#article-highlight').show();
  }

  function textHighlightAll(keywords)
  {
      var summary_text = document.getElementById("summarised-article-content");
      var arr = Array.from(keywords.split(" "));
      for (idx in arr) {
        summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp(arr[idx], "ig" ),"<span class=\"highlight\">"+ '\$&'+"</span>");
      }
      $('#text-highlight').hide();
      $('#text-unhighlight').show();
  }

  function textUnhighlightAll()
  {
      var summary_text = document.getElementById("summarised-article-content");
      summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp("<span class=\"highlight\">", "ig" ),"");
      summary_text.innerHTML = summary_text.innerHTML.replace(new RegExp("</span>", "ig" ),"");
      $('#text-unhighlight').hide();
      $('#text-highlight').show();
  }

</script>

<style>
.highlight
{
background-color:yellow;
}

.clickableSpan {
    cursor: pointer;
}

.bar-chart-title {
    width: 450px;
    height: 50px;
}

.bar-chart-legend {
    overflow: hidden;
    width: 450px;
    height: 50px;
    text-align: center;
}

.bar-container-legend {
  margin-right: 10px;
  width: 450px;
  height: 50px;
}

.key-section {
    height: 30px;
    float:left;
    width: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.positive {
    background-color: #93FF33;
}
.neutral {
    background-color: #FFF933;
}
.negative {
    background-color: #FF5833
}

.bar-chart {
	  overflow: hidden;
    width: 450px;
    height: 50px;
}
.bar-container {
  margin-right: 10px;
  width: 450px;
  height: 50px;
}
.bar {
    height: 50px;
    float:left;
}
.positive {
    background-color: #93FF33;
}
.neutral {
    background-color: #FFF933;
}
.negative {
    background-color: #FF5833
}

</style>

{% endblock %}
